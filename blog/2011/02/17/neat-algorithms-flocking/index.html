
<!doctype html>
<!--[if lt IE 7]><html <?php language_attributes(); ?> class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html <?php language_attributes(); ?> class="no-js lt-ie9 lt-ie8"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html <?php language_attributes(); ?> class="no-js lt-ie9"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"><!--<![endif]-->
	<head>
		<meta charset="utf-8">
    <title>Neat Algorithms - Flocking - Will You Harry Me</title>

		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

		<meta name="HandheldFriendly" content="True">
		<meta name="MobileOptimized" content="320">
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  
  <link rel="canonical" href="http://harry.me/blog/2011/02/17/neat-algorithms-flocking">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/style.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/assets/fonts/font-awesome.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://fonts.googleapis.com/css?family=Crimson+Text|Ubuntu:400,700" rel="stylesheet" type="text/css">
  <!--[if lt IE 9]>
  <link href="/stylesheets/ie.css" media="screen, projection" rel="stylesheet" type="text/css">
  <![endif]-->

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
  <link rel="apple-touch-icon-precomposed" sizes="72x72"   href="/images/apple-touch-icon-72x72-precomposed.png">
  <link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">

  <script type="text/javascript" src="/javascripts/modernizr.custom.min.js"></script>
  <script type="text/javascript" src="/javascripts/jquery-1.9.1.min.js"></script>
  <script type="text/javascript" src="/javascripts/jquery.imagesloaded.min.js"></script>

  
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-15787846-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    
  <script type="text/javascript">
    var Harry = {};
  </script>
	</head>


<body class="blog ">
  <div id="container">
    <header class="header" role="banner">
      <div id="inner-header" class="wrap clearfix">
        <div class="logo">
          <h1><a href="/" rel="nofollow">Will You Harry Me?</a></h1>
        </div>

        <div class="menu">
          <nav role="navigation">
            <a class="toggleMenu" href="#" style="display: inline-block;"><i class="icon-reorder"></i></a>
            <ul id="menu-main" class="nav top-nav clearfix">
              <li class="menu-item menu-item-home"><a href="/">Home</a></li>
              <li class="menu-item"><a href="/about/">About</a></li>
            </ul>
          </nav>
        </div>
      </div>
    </header>

    
<div id="featured-wrap">
  <img src="/images/headers/flocking.jpg" class="attachment-creer-full wp-post-image" />
  <div class="feature-credit">photo credit: Carter Brundage</div>
</div>



<div id="content" class="single">
  <div id="inner-content" class="wrap clearfix">
    <div id="main" class="twelvecol clearfix" role="main">
      <article class="clearfix post" role="article" itemscope itemtype="http://schema.org/BlogPosting">
        <header class="article-header pushfourcol">
          <span class="published">








  




<time datetime="2011-02-17T12:41:00-05:00" pubdate data-updated="true"></time></span>
          <h1 class="entry-title single-title" itemprop="headline">Neat Algorithms - Flocking</h1>
        </header>

        <section class="entry-content clearfix" itemprop="articleBody">
          <div id="postmeta" class="fourcol first clearfix">
            <p class="byline vcard">

            <span class="byline author vcard">
                
                  
                
                By <a href="/about/" rel="author">Harry Brundage</a>
              </span>

              
              
              
                

<span class="categories">
  Concerning: 
  
    <a class='category' href='/blog/categories/neat-algos/'>neat algos</a>
  
</span>


              
              <span class="count">Words: <strong>2393</strong></span>
              </p>

            
              <p class="share">
  
  <span class="facebook">
    <span class="facebook"><a href="http://www.facebook.com/sharer.php?u=http://harry.me/blog/2011/02/17/neat-algorithms-flocking/&t=Neat Algorithms - Flocking" target="blank"><i class="icon-facebook"></i></a>
  </span>
  
  
  <span class="twitter">
    <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://harry.me/blog/2011/02/17/neat-algorithms-flocking/" data-via="harrybrundage" data-counturl="http://harry.me/blog/2011/02/17/neat-algorithms-flocking/" ><i class="icon-twitter"></i></a>
  </span>
  
</p>

            
          </div>

          <div id="post-content">
            <p>In this post I&rsquo;ll explain and demonstrate an algorithm that simulates a group of entities grouping together, illustrating something called &ldquo;flocking&rdquo;. I think it&rsquo;s quite neat because the flock exhibits some complex collective intelligence when just a few simple governing rules are applied to each entity.</p>

<!--more-->


<p>The <a href="http://www.red3d.com/cwr/boids/">original flocking algorithm</a> was developed by <a href="http://www.red3d.com/cwr/index.html">Craig Reynolds</a> in 1986, and has some super cool real world applications:</p>

<ul>
<li>Computer animation. <a href="http://www.imdb.com/title/tt0103776/awards" title="Batman Returns (1992) Awards list">Batman Returns (1992)</a> is widely quoted as having been nominated for an Oscar for its bat swarms which were procedurally generated using algorithms similar to these.</li>
<li>Social network simulation and modeling opinion flow. After choosing humans as the entities in the flock, the overall direction of the flock can be estimated using the rules that apply to the simple flock model, and people&rsquo;s future opinions can be predicted. See <a href="http://www.gamasutra.com/view/feature/1815/modeling_opinion_flow_in_humans_.php" title="Modeling opinion flow using Boid algorithms at Gamasutra">Gamasutra</a>&rsquo;s stupendous article on the subject.</li>
<li>Aerospace engineering. By sending <a href="http://en.wikipedia.org/wiki/Unmanned_aerial_vehicle">UAV</a>s on missions in flocks they are able to more effectively complete their missions and react to enemy events. See <a href="http://ieeexplore.ieee.org/xpl/freeabs_all.jsp?arnumber=1470734" title="Paper from the ACC in 2005 describing the performance of UAV flock missions">one paper</a> and <a href="http://ieeexplore.ieee.org/Xplore/login.jsp?url=http://ieeexplore.ieee.org/iel5/5351161/5356514/05356552.pdf%3Farnumber%3D5356552&amp;authDecision=-203" title="Paper from the ACC in 2005 describing the performance of UAV flock missions">another</a> on the subject.</li>
<li>Distributed systems analysis, search, and optimization. By modeling things like spacial data, network traffic, or solutions to an optimization problem as entities, the direction of the flock can be used to find <a href="http://www.springerlink.com/content/c7t0fb6a54flkrw8/" title="Paper on performant parallel spacial clustering from 2002">clusters</a>, where to push traffic, or <a href="http://www.engr.iupui.edu/~shi/pso.html" title="Page on particle swarm optimization with references.">optimal solutions</a>.</li>
</ul>


<p>Here&rsquo;s the full algorithm in action:</p>

<div class="flock" id="prettyDemo"></div>


<p>You can also turn on a legend and a magnified view of one boid: <button class="awesome" id="decorateDemo">Decorate</button></p>

<h2>How it Works</h2>

<p>Each entity on the map, which we&rsquo;ll now refer to as a &ldquo;boid&rdquo;, moves around while being governed by a few simple rules. Each boid starts out at the center of the map with a random velocity, and for each frame of the simulation, a new velocity is calculated using the flocking algorithm. For each boid, the algorithm uses the boid&rsquo;s current velocity, its neighbours' velocities, and its position relative to its neighbours to calculate this new velocity. There are three components to it: the <em>alignment</em>, the <em>cohesion</em>, and the <em>separation</em>, which when used in combination display the full blown flocking behaviour.</p>

<h2>About this page</h2>

<p>At any time you can click on any of the demos to stop or start the boid&rsquo;s movement. The lower ones also have buttons allowing you to control the speed at which the boids move. When the movement is stopped you can hover your mouse over a boid to inspect the components of its velocity, as generated by the flocking algorithm. The boids also have an elephantine weakness: they are afraid of mice. Feel free to perturb the flock using your mouse while the boids are moving, and watch them try and regroup.</p>

<p>All the demos are running the same algorithm, just with random start positions and random start velocities. The code running the demos as well as the example code on the page is done in <a href="http://coffeescript.org/">Coffeescript</a>. If you haven&rsquo;t seen it before, it shouldn&rsquo;t be too hard to pick up, but visit that page if you want a quick primer on the syntax. Also, the example code on this page is the distilled version of the running code, algorithmically complete but missing a lot of the boring nuances arising from actual implementation, such as a lot of the code to render the boids, wrap them around the edges of the map, and display the indicators. The code running the actual demos can be found <a href="https://github.com/hornairs/blog/tree/master/assets/coffeescripts/flocking">here</a>, and isn&rsquo;t really all that interesting.</p>

<h3>The code &amp; components</h3>

<p>Heres the essence of the Coffeescript class modeling the boid. Each boid has a <code>location</code> and a <code>velocity</code>, which are represented as <code>Vector</code> objects (<a href="https://github.com/hornairs/blog/blob/master/assets/coffeescripts/flocking/vector.coffee">source</a>). Each frame calls the <code>step</code> method on each boid, which calculates an acceleration based on the 3 components. This acceleration is added to the velocity, which is then limited to a maxmium magnitude so the boid can&rsquo;t go too fast. The new velocity is added to the location to translate the boid on the map.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="c1"># Ported almost directly from http://processingjs.org/learning/topic/flocking</span>
</span><span class='line'><span class="c1"># thanks a whole lot to Craig Reynolds and Daniel Shiffman</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nx">Boid</span>
</span><span class='line'>  <span class="nv">location: </span><span class="kc">false</span>
</span><span class='line'>  <span class="nv">velocity: </span><span class="kc">false</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">constructor: </span><span class="nf">(loc, processing) -&gt;</span>
</span><span class='line'>    <span class="vi">@velocity = </span><span class="k">new</span> <span class="nx">Vector</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@location = </span><span class="nx">loc</span><span class="p">.</span><span class="nx">copy</span><span class="p">()</span>
</span><span class='line'>    <span class="vi">@p = </span><span class="nx">processing</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Called every frame. Calculates the acceleration using the flock method,</span>
</span><span class='line'>  <span class="c1"># and moves the boid based on it.</span>
</span><span class='line'>  <span class="nv">step: </span><span class="nf">(neighbours) -&gt;</span>
</span><span class='line'>    <span class="nv">acceleration = </span><span class="k">this</span><span class="p">.</span><span class="nx">flock</span><span class="p">(</span><span class="nx">neighbours</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># Limit the maximum speed at which a boid can go</span>
</span><span class='line'>    <span class="nx">@velocity</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">acceleration</span><span class="p">).</span><span class="nx">limit</span><span class="p">(</span><span class="nx">MAX_SPEED</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">@location</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">@velocity</span><span class="p">)</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">_wrapIfNeeded</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Implements the flocking algorthim by collecting the three components</span>
</span><span class='line'>  <span class="c1"># and returning a weighted sum.</span>
</span><span class='line'>  <span class="nv">flock: </span><span class="nf">(neighbours) -&gt;</span>
</span><span class='line'>    <span class="nv">separation = </span><span class="k">this</span><span class="p">.</span><span class="nx">separate</span><span class="p">(</span><span class="nx">neighbours</span><span class="p">).</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">SEPARATION_WEIGHT</span><span class="p">)</span>
</span><span class='line'>    <span class="nv">alignment = </span><span class="k">this</span><span class="p">.</span><span class="nx">align</span><span class="p">(</span><span class="nx">neighbours</span><span class="p">).</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">ALIGNMENT_WEIGHT</span><span class="p">)</span>
</span><span class='line'>    <span class="nv">cohesion = </span><span class="k">this</span><span class="p">.</span><span class="nx">cohere</span><span class="p">(</span><span class="nx">neighbours</span><span class="p">).</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">COHESION_WEIGHT</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">separation</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">alignment</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">cohesion</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next up is the three components which generate the acceleration.</p>

<h3>Cohesion</h3>

<div class="flock" id="cohesionDemo"></div>


<p>A flock is defined as a group of boids all staying close to each together, and the <em>cohesion</em> component of the algorithm is mainly responsible for the togetherness aspect of this. Every frame, each boid looks at the position of each other boid to see if it is within a specified <code>NEIGHBOUR_RADIUS</code>, that is, it checks to see which other boids are close enough to be considered flockmates. The positions of the qualifying neighbours are averaged and the boid steers to towards that position. This way, each boid is trying to steer towards the center of the flock, resulting in them all staying close together.</p>

<p>The example on the right shows how the cohesion component of the algorithm works. The pink boid&rsquo;s <code>NEIGHBOUR_RADIUS</code> is drawn as the green circle around it, and boids inside it (neighbours) are drawn as green instead of blue when they are inside it. Their locations (the dark purple vectors) are summed up to find the center of the flock. The light pink vector points to this center point which the pink boid is trying to reach. The blue vector shows the path by which the boid steers towards this center point. This steering vector looks a tad odd, but have a look at the code to see why it is necessary.</p>

<p>Also note that if a boid has only one neighbour, the center of its neighbouring flock is exactly its neighbour&rsquo;s location. In this case the dark purple vector has a zero magnitude (it starts and ends at the same point), and the light purple vector points to the position of that neighbour.</p>

<h4>Code</h4>

<p>The cohesion component is calculated by averaging the location of all the neighbours within the <code>NEIGHBOUR_RADIUS</code>. Note that the returned value is the result of calling <code>steer_to</code> on the average position. The <code>steer_to</code> method implements some basic easing towards a target so the boids turn towards fellow flock members at reasonable speeds instead of instantly switching direction. You can also see this as an implementation of friction and reaction speeds.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="k">class</span> <span class="nx">Boid</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Called to get the cohesion component of the acceleration</span>
</span><span class='line'>  <span class="nv">cohere: </span><span class="nf">(neighbours) -&gt;</span>
</span><span class='line'>    <span class="nv">sum = </span><span class="k">new</span> <span class="nx">Vector</span>
</span><span class='line'>    <span class="nv">count = </span><span class="mi">0</span>
</span><span class='line'>    <span class="k">for</span> <span class="nx">boid</span> <span class="k">in</span> <span class="nx">neighbours</span>
</span><span class='line'>      <span class="nv">d = </span><span class="nx">@location</span><span class="p">.</span><span class="nx">distance</span><span class="p">(</span><span class="nx">boid</span><span class="p">.</span><span class="nx">location</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">d</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">d</span> <span class="o">&lt;</span> <span class="nx">NEIGHBOUR_RADIUS</span>
</span><span class='line'>        <span class="nx">sum</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">boid</span><span class="p">.</span><span class="nx">location</span><span class="p">)</span>
</span><span class='line'>        <span class="nx">count</span><span class="o">++</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="nx">count</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">steer_to</span> <span class="nx">sum</span><span class="p">.</span><span class="nx">divide</span><span class="p">(</span><span class="nx">count</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">sum</span> <span class="c1"># Empty vector contributes nothing</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">steer_to: </span><span class="nf">(target) -&gt;</span>
</span><span class='line'>    <span class="c1"># A vector pointing from the location to the target</span>
</span><span class='line'>    <span class="nv">desired = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">@location</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># Distance from the target is the magnitude of the vector</span>
</span><span class='line'>    <span class="nv">d = </span><span class="nx">desired</span><span class="p">.</span><span class="nx">magnitude</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># If the distance is greater than 0, calc steering</span>
</span><span class='line'>    <span class="c1"># (otherwise return zero vector)</span>
</span><span class='line'>    <span class="k">if</span> <span class="nx">d</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span class='line'>      <span class="nx">desired</span><span class="p">.</span><span class="nx">normalize</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Two options for desired vector magnitude</span>
</span><span class='line'>      <span class="c1"># (1 -- based on distance, 2 -- maxspeed)</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">d</span> <span class="o">&lt;</span> <span class="mf">100.0</span>
</span><span class='line'>        <span class="c1"># This damping is arbitrary</span>
</span><span class='line'>        <span class="nx">desired</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">MAX_SPEED</span><span class="o">*</span><span class="p">(</span><span class="nx">d</span><span class="o">/</span><span class="mf">100.0</span><span class="p">))</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="nx">desired</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">MAX_SPEED</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Steering = Desired minus Velocity</span>
</span><span class='line'>      <span class="nv">steer = </span><span class="nx">desired</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">@velocity</span><span class="p">)</span>
</span><span class='line'>      <span class="c1"># Limit to maximum steering force</span>
</span><span class='line'>      <span class="nx">steer</span><span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="nx">MAX_FORCE</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="nv">steer = </span><span class="k">new</span> <span class="nx">Vector</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nx">steer</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Alignment</h3>

<div class="flock" id="alignmentDemo"></div>


<p>Each boid in a flock tries to head in the same direction as the rest of the flock, which is the responsibility of the <em>alignment</em> portion of the algorithm. Each frame, each boid looks at the heading in which it is travelling in comparison to the headings of all its neighbours, and realigns itself to match their heading. The velocity vectors of each boid within the <code>NEIGHBOUR_RADIUS</code> are averaged and the resulting vector points in the average direction of the flock, which the boid then tried to head in.</p>

<p>In the example on the left, the neighbouring boids are highlighted in green, and their velocities are shown in light green. Each of those velocities is averaged to find the average heading the pink boid should head in. This new heading is shown as the bright green vector coming from the pink boid. You can also see the pink boid&rsquo;s velocity as the black vector, and notice how if the angle between the current velocity in black and the average alignment of the neighbours in bright green is large, it gradually decreases as the boid adopts the new heading.</p>

<h4>Code</h4>

<p>The alignment is calculated by averaging the velocities of the neighbours within the <code>NEIGHBOUR_RADIUS</code>. The return value is also <code>limited</code> to exert no more than the maximum force. This is so that the alignment component can&rsquo;t overpower the others, which can happen if there is a big difference between the current boid and its neighbours' velocities.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="k">class</span> <span class="nx">Boid</span>
</span><span class='line'>  <span class="c1"># Alignment component for the frame&#39;s acceleration</span>
</span><span class='line'>  <span class="nv">align: </span><span class="nf">(neighbours) -&gt;</span>
</span><span class='line'>    <span class="nv">mean = </span><span class="k">new</span> <span class="nx">Vector</span>
</span><span class='line'>    <span class="nv">count = </span><span class="mi">0</span>
</span><span class='line'>    <span class="k">for</span> <span class="nx">boid</span> <span class="k">in</span> <span class="nx">neighbours</span>
</span><span class='line'>      <span class="nv">d = </span><span class="nx">@location</span><span class="p">.</span><span class="nx">distance</span><span class="p">(</span><span class="nx">boid</span><span class="p">.</span><span class="nx">location</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">d</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">d</span> <span class="o">&lt;</span> <span class="nx">NEIGHBOUR_RADIUS</span>
</span><span class='line'>        <span class="nx">mean</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">boid</span><span class="p">.</span><span class="nx">velocity</span><span class="p">)</span>
</span><span class='line'>        <span class="nx">count</span><span class="o">++</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">mean</span><span class="p">.</span><span class="nx">divide</span><span class="p">(</span><span class="nx">count</span><span class="p">)</span> <span class="k">if</span> <span class="nx">count</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span class='line'>    <span class="nx">mean</span><span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="nx">MAX_FORCE</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">mean</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Separation</h3>

<div class="flock" id="separationDemo"></div>


<p>While in a flock, each boid tries not to run into each other one in the flock. They try to remain <em>separate</em> by keeping a specified amount of space in between themselves. Each boid checks all the other boids on the map to see if the distance between them is too small, and if so, adds an inversely proportional amount to its velocity in the opposite direction.</p>

<p>In the example on the right you can see the red circle which indicates the desired separation around the pink boid. If a boid enters this radius, the pink boid tries to navigate away. Boids which violate the pink boid&rsquo;s desired separation are also highlighted in red. The red arrow pointing out of the pink boid is the separation component of the algorithm, pointing away from any boids that are too close. Note that right at the start, all the boids are too close to the pink one, so they are all highlighted in red.</p>

<h4>Code</h4>

<p>The code loops through the neighbours as the other methods do while checking each neighbour to see if the distance to it is less than the <code>DESIRED_SEPARATION</code>. If it is, the vector going between the two boids is found such that it is pointing away from the uncomfortably close boid. This vector is normalized, and then scaled up proportionally to how close the boid is. If the foreign boid is closer, the vector is larger, and the current boid will move away faster.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="k">class</span> <span class="nx">Boid</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Separation component for the frame&#39;s acceleration</span>
</span><span class='line'>  <span class="nv">separate: </span><span class="nf">(neighbours) -&gt;</span>
</span><span class='line'>    <span class="nv">mean = </span><span class="k">new</span> <span class="nx">Vector</span>
</span><span class='line'>    <span class="nv">count = </span><span class="mi">0</span>
</span><span class='line'>    <span class="k">for</span> <span class="nx">boid</span> <span class="k">in</span> <span class="nx">neighbours</span>
</span><span class='line'>      <span class="nv">d = </span><span class="nx">@location</span><span class="p">.</span><span class="nx">distance</span><span class="p">(</span><span class="nx">boid</span><span class="p">.</span><span class="nx">location</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">d</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">d</span> <span class="o">&lt;</span> <span class="nx">DESIRED_SEPARATION</span>
</span><span class='line'>        <span class="c1"># Normalized, weighted by distance vector pointing away from the neighbour</span>
</span><span class='line'>        <span class="nx">mean</span><span class="p">.</span><span class="nx">add</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="nx">@location</span><span class="p">,</span><span class="nx">boid</span><span class="p">.</span><span class="nx">location</span><span class="p">).</span><span class="nx">normalize</span><span class="p">().</span><span class="nx">divide</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>
</span><span class='line'>        <span class="nx">count</span><span class="o">++</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">mean</span><span class="p">.</span><span class="nx">divide</span><span class="p">(</span><span class="nx">count</span><span class="p">)</span> <span class="k">if</span> <span class="nx">count</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span class='line'>    <span class="nx">mean</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Bringing it all together</h2>

<p>Once the component accelerations have been calculated, the weighted sum can be taken, and the final acceleration can be applied to the boid&rsquo;s velocity, as is shown at the beginning of the post. A small script like the one below is needed to manage each boid and <code>step</code> each one in sequence. To render this whole thing, I used <a href="http://processingjs.org/">Processing.js</a>, which was an absolute joy. The code (which has nothing to do with the flocking algorithm) to render the boid is below. For more on the Processing part of this page, I encourage you to check out the source for this page on <a href="https://github.com/hornairs/blog/blob/master/assets/coffeescripts/flocking/flock.coffee">Github</a>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="k">class</span> <span class="nx">Boid</span>
</span><span class='line'>  <span class="nv">r: </span><span class="mi">2</span> <span class="c1"># &quot;radius&quot; of the triangle</span>
</span><span class='line'>  <span class="nv">render: </span><span class="p">()</span> <span class="nf">-&gt;</span>
</span><span class='line'>    <span class="c1"># Draw a triangle rotated in the direction of velocity</span>
</span><span class='line'>    <span class="nv">theta = </span><span class="nx">@velocity</span><span class="p">.</span><span class="nx">heading</span><span class="p">()</span> <span class="o">+</span> <span class="nx">@p</span><span class="p">.</span><span class="nx">radians</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">@p</span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="mi">70</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">@p</span><span class="p">.</span><span class="nx">stroke</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">@p</span><span class="p">.</span><span class="nx">pushMatrix</span><span class="p">()</span>
</span><span class='line'>    <span class="nx">@p</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="nx">@location</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="nx">@location</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">@p</span><span class="p">.</span><span class="nx">rotate</span><span class="p">(</span><span class="nx">theta</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">@p</span><span class="p">.</span><span class="nx">beginShape</span><span class="p">(</span><span class="nx">@p</span><span class="p">.</span><span class="nx">TRIANGLES</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">@p</span><span class="p">.</span><span class="nx">vertex</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">@r</span> <span class="o">*</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">@p</span><span class="p">.</span><span class="nx">vertex</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">@r</span><span class="p">,</span> <span class="nx">@r</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">@p</span><span class="p">.</span><span class="nx">vertex</span><span class="p">(</span><span class="nx">@r</span><span class="p">,</span> <span class="nx">@r</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">@p</span><span class="p">.</span><span class="nx">endShape</span><span class="p">()</span>
</span><span class='line'>    <span class="nx">@p</span><span class="p">.</span><span class="nx">popMatrix</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># flock function, passed the Processing instance by Processing itself</span>
</span><span class='line'><span class="nv">flock = </span><span class="nf">(processing) -&gt;</span>
</span><span class='line'>  <span class="nv">start = </span><span class="k">new</span> <span class="nx">Vector</span><span class="p">(</span><span class="nx">processing</span><span class="p">.</span><span class="nx">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="nx">processing</span><span class="p">.</span><span class="nx">height</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Instantiate 100 boids who start in the middle of the map, have a maxmimum</span>
</span><span class='line'>  <span class="c1"># speed of 2, maximum force of 0.05, and give them a reference to the</span>
</span><span class='line'>  <span class="c1"># processing instance so they can render themselves.</span>
</span><span class='line'>  <span class="nv">boids = </span><span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">100</span><span class="p">]</span>
</span><span class='line'>    <span class="k">new</span> <span class="nx">Boid</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="nx">processing</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">processing.draw = </span><span class="nf">-&gt;</span>
</span><span class='line'>    <span class="nx">processing</span><span class="p">.</span><span class="nx">background</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>
</span><span class='line'>    <span class="k">for</span> <span class="nx">boid</span> <span class="k">in</span> <span class="nx">boids</span>
</span><span class='line'>      <span class="nx">boid</span><span class="p">.</span><span class="nx">step</span><span class="p">(</span><span class="nx">boids</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">boid</span><span class="p">.</span><span class="nx">render</span><span class="p">()</span>
</span><span class='line'>    <span class="kc">true</span>
</span><span class='line'>
</span><span class='line'><span class="nv">canvas = </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;&lt;canvas width=&quot;550&quot; height=&quot;550&quot;&gt;&lt;/canvas&gt;&#39;</span><span class="p">).</span><span class="nx">appendTo</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#flockingDemo&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'><span class="nv">processingInstance = </span><span class="k">new</span> <span class="nx">Processing</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span> <span class="nx">flock</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s it! You can now stir up your own flocks of tiny little dudes to watch and herd about.</p>

<h2>Wrap Up</h2>

<p>I hope you found this informative! If you have any questions, comments, corrections, or know of any neat uses of flocking algorithms in the wild (baha!), please leave them below. Also, thanks again to Craig Reynolds for publishing his code in the first place and Daniel Shiffman for creating a basic Processing version of it.</p>

<h3>Thanks</h3>

<p>Thanks to Craig Reynolds for coming up with the algorithm and Daniel Shiffman for the initial port to Processing. Daniel is working on a new, free book called &ldquo;The Nature of Code&rdquo;, exploring what properties of nature we can find and use while coding. He&rsquo;s publishing the draft chapters for anyone who helps fund the project on Kickstarter, so if you like this kind of thing you could help contribute to it on <a href="https://www.kickstarter.com/projects/shiffman/the-nature-of-code-book-project">Kickstarter</a>.</p>

<p>Also, thanks to <a href="http://fustat.org/">Mo</a> for helping edit.</p>

<script src="/assets/flocking/flocking-f0fe0199b1533c6996fe876bb1982469.js"></script>


<p><link rel="stylesheet" href="/assets/flocking-e3ea43befd4dabf41388802712fd8632.css"></p>

          </div>
        </section>

        <footer class="article-footer clearfix">
          <nav id="post-entries" class="clearfix">
            
            <div class="nav-prev fl">
              <a rel="prev" href="/blog/2011/01/27/today-web-development-sucks/" title="Previous Post: Today, Web Development Sucks">
                <span class="meta">Previous</span>
                <span class="link">Today, Web Development Sucks</span>
              </a>
            </div>
            
            
            <div class="nav-next fr">
              <a rel="next" href="/blog/2011/05/11/converting-from-jasmine-to-qunit/" title="Next Post: Converting from Jasmine to QUnit">
                <span class="meta">Next</span>
                <span class="link">Converting from Jasmine to QUnit</span>
              </a>
            </div>
            
          </nav>
        </footer>

        

        <div class="eightcol last clearfix">
          
        </div>
      </article> <!-- end article -->
    </div>
  </div> <!-- end #inner-content -->
</div> <!-- end #content -->


    <footer class="footer" role="contentinfo">
    <div id="inner-footer" class="wrap clearfix">
      <nav role="navigation">
        <ul id="menu-footer" class="nav footer-nav clearfix">
          <li class="menu-item"><a href="/">Home</a></li>
          <li class="menu-item"><a href="/about/">About</a></li>
          <li class="menu-item"><a href="/blog/archives">Archives</a></li>
          <li class="menu-item"><a href="mailto:harry@harry.me">Contact</a></li>
        </ul>
      </nav>
    </div>
  </footer>
</div>

<a href="#" id="back-to-top"><i class="icon-angle-up"></i></a>
<script type="text/javascript" src="/javascripts/jquery.fitvids.js"></script>
<script type="text/javascript" src="/javascripts/scripts.js"></script>
<script type="text/javascript" src="/javascripts/nav.js"></script>
<script type="text/javascript" src="/javascripts/jquery.infinitescroll.min.js"></script>



</body>
</html>

